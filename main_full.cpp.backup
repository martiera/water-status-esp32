#include <Arduino.h>
#include <WiFi.h>
#include <PubSubClient.h>
#include <WebServer.h>
#include <ArduinoJson.h>
#include "config.h"
// #include "display.h"  // Temporarily disabled
#include "web_interface.h"

// Global objects
ConfigManager configManager;
// DisplayManager display;  // Temporarily disabled
WiFiClient espClient;
PubSubClient mqttClient(espClient);
WebServer server(80);

// Status variables
bool wifiConnected = false;
bool mqttConnected = false;
unsigned long lastMqttReconnect = 0;
unsigned long lastDisplayUpdate = 0;
const unsigned long MQTT_RECONNECT_INTERVAL = 5000;
const unsigned long DISPLAY_UPDATE_INTERVAL = 1000;

// AP mode flag
bool apMode = false;

// Function declarations
void setupWiFi();
void setupMQTT();
void setupWebServer();
void mqttCallback(char* topic, byte* payload, unsigned int length);
void reconnectMQTT();
void handleRoot(AsyncWebServerRequest *request);
void handleSave(AsyncWebServerRequest *request, uint8_t *data, size_t len, size_t index, size_t total);
void handleGetConfig(AsyncWebServerRequest *request);

void setup() {
    Serial.begin(115200);
    delay(1000);
    
    Serial.println("\n\n=================================");
    Serial.println("Water Status Monitor Starting...");
    Serial.println("=================================\n");
    
    // Initialize configuration
    configManager.begin();
    Config& config = configManager.getConfig();
    
    // Initialize display
    display.begin(config.screen_brightness);
    display.setTemperatureUnit(config.celsius);
    display.setThresholds(config.min_tank_temp, config.min_out_pipe_temp);
    
    // Check if WiFi is configured
    if (strlen(config.wifi_ssid) == 0) {
        Serial.println("No WiFi configured - Starting AP mode");
        apMode = true;
        
        // Show config mode on display
        display.showConfigMode();
        
        // Start Access Point
        WiFi.mode(WIFI_AP);
        WiFi.softAP("Water-Status-AP", "12345678");
        Serial.println("AP IP address: " + WiFi.softAPIP().toString());
        
        // Setup web server only
        setupWebServer();
    } else {
        // Normal operation mode
        setupWiFi();
        setupMQTT();
        setupWebServer();
        
        display.refresh();
    }
}

void loop() {
    if (apMode) {
        // In AP mode, just handle web requests
        delay(100);
        return;
    }
    
    // Check WiFi connection
    if (WiFi.status() != WL_CONNECTED) {
        if (wifiConnected) {
            wifiConnected = false;
            Serial.println("WiFi disconnected!");
            display.updateConnectionStatus(false, mqttConnected);
        }
        delay(500);
        return;
    } else if (!wifiConnected) {
        wifiConnected = true;
        Serial.println("WiFi reconnected!");
        display.updateConnectionStatus(true, mqttConnected);
    }
    
    // Handle MQTT
    if (!mqttClient.connected()) {
        if (mqttConnected) {
            mqttConnected = false;
            display.updateConnectionStatus(wifiConnected, false);
        }
        
        unsigned long now = millis();
        if (now - lastMqttReconnect > MQTT_RECONNECT_INTERVAL) {
            lastMqttReconnect = now;
            reconnectMQTT();
        }
    } else {
        if (!mqttConnected) {
            mqttConnected = true;
            display.updateConnectionStatus(wifiConnected, true);
        }
        mqttClient.loop();
    }
    
    // Update display periodically
    unsigned long now = millis();
    if (now - lastDisplayUpdate > DISPLAY_UPDATE_INTERVAL) {
        lastDisplayUpdate = now;
        display.refresh();
    }
    
    delay(10);
}

void setupWiFi() {
    Config& config = configManager.getConfig();
    
    Serial.println("Connecting to WiFi: " + String(config.wifi_ssid));
    
    WiFi.mode(WIFI_STA);
    WiFi.begin(config.wifi_ssid, config.wifi_password);
    
    int attempts = 0;
    while (WiFi.status() != WL_CONNECTED && attempts < 20) {
        delay(500);
        Serial.print(".");
        attempts++;
    }
    
    if (WiFi.status() == WL_CONNECTED) {
        wifiConnected = true;
        Serial.println("\nWiFi connected!");
        Serial.println("IP address: " + WiFi.localIP().toString());
    } else {
        Serial.println("\nWiFi connection failed!");
    }
}

void setupMQTT() {
    Config& config = configManager.getConfig();
    
    mqttClient.setServer(config.mqtt_server, config.mqtt_port);
    mqttClient.setCallback(mqttCallback);
    
    Serial.println("MQTT configured for: " + String(config.mqtt_server) + ":" + String(config.mqtt_port));
}

void reconnectMQTT() {
    Config& config = configManager.getConfig();
    
    Serial.print("Attempting MQTT connection...");
    
    bool connected;
    if (strlen(config.mqtt_user) > 0) {
        connected = mqttClient.connect(config.mqtt_client_id, config.mqtt_user, config.mqtt_password);
    } else {
        connected = mqttClient.connect(config.mqtt_client_id);
    }
    
    if (connected) {
        Serial.println("connected!");
        
        // Subscribe to all temperature topics
        mqttClient.subscribe(config.topic_tank_temp);
        mqttClient.subscribe(config.topic_out_pipe_temp);
        mqttClient.subscribe(config.topic_heating_in_temp);
        mqttClient.subscribe(config.topic_heating_out_temp);
        
        Serial.println("Subscribed to topics:");
        Serial.println("  - " + String(config.topic_tank_temp));
        Serial.println("  - " + String(config.topic_out_pipe_temp));
        Serial.println("  - " + String(config.topic_heating_in_temp));
        Serial.println("  - " + String(config.topic_heating_out_temp));
        
        mqttConnected = true;
    } else {
        Serial.print("failed, rc=");
        Serial.println(mqttClient.state());
    }
}

void mqttCallback(char* topic, byte* payload, unsigned int length) {
    // Convert payload to string
    char message[length + 1];
    memcpy(message, payload, length);
    message[length] = '\0';
    
    float temperature = atof(message);
    
    Config& config = configManager.getConfig();
    
    Serial.print("MQTT received on ");
    Serial.print(topic);
    Serial.print(": ");
    Serial.println(temperature);
    
    // Determine which sensor and update display
    if (strcmp(topic, config.topic_tank_temp) == 0) {
        display.updateTemperature(0, temperature);
    } else if (strcmp(topic, config.topic_out_pipe_temp) == 0) {
        display.updateTemperature(1, temperature);
    } else if (strcmp(topic, config.topic_heating_in_temp) == 0) {
        display.updateTemperature(2, temperature);
    } else if (strcmp(topic, config.topic_heating_out_temp) == 0) {
        display.updateTemperature(3, temperature);
    }
}

void setupWebServer() {
    // Serve main page
    server.on("/", HTTP_GET, handleRoot);
    
    // Get current configuration
    server.on("/config", HTTP_GET, handleGetConfig);
    
    // Save configuration
    server.on("/save", HTTP_POST, [](AsyncWebServerRequest *request){}, NULL, handleSave);
    
    server.begin();
    Serial.println("Web server started");
    
    if (apMode) {
        Serial.println("Access configuration at: http://192.168.4.1");
    } else {
        Serial.println("Access configuration at: http://" + WiFi.localIP().toString());
    }
}

void handleRoot(AsyncWebServerRequest *request) {
    request->send_P(200, "text/html", HTML_PAGE);
}

void handleGetConfig(AsyncWebServerRequest *request) {
    Config& config = configManager.getConfig();
    
    StaticJsonDocument<1024> doc;
    doc["wifi_ssid"] = config.wifi_ssid;
    doc["wifi_password"] = ""; // Don't send password back
    doc["mqtt_server"] = config.mqtt_server;
    doc["mqtt_port"] = config.mqtt_port;
    doc["mqtt_user"] = config.mqtt_user;
    doc["mqtt_password"] = ""; // Don't send password back
    doc["topic_tank"] = config.topic_tank_temp;
    doc["topic_out"] = config.topic_out_pipe_temp;
    doc["topic_heat_in"] = config.topic_heating_in_temp;
    doc["topic_heat_out"] = config.topic_heating_out_temp;
    doc["min_tank"] = config.min_tank_temp;
    doc["min_out"] = config.min_out_pipe_temp;
    
    String response;
    serializeJson(doc, response);
    request->send(200, "application/json", response);
}

void handleSave(AsyncWebServerRequest *request, uint8_t *data, size_t len, size_t index, size_t total) {
    static String body;
    
    // Accumulate body
    if (index == 0) {
        body = "";
    }
    for (size_t i = 0; i < len; i++) {
        body += (char)data[i];
    }
    
    // Process when complete
    if (index + len == total) {
        StaticJsonDocument<1024> doc;
        DeserializationError error = deserializeJson(doc, body);
        
        if (error) {
            request->send(400, "text/plain", "Invalid JSON");
            return;
        }
        
        Config& config = configManager.getConfig();
        
        // Update configuration
        if (doc.containsKey("wifi_ssid")) {
            strncpy(config.wifi_ssid, doc["wifi_ssid"], sizeof(config.wifi_ssid) - 1);
        }
        if (doc.containsKey("wifi_password") && strlen(doc["wifi_password"]) > 0) {
            strncpy(config.wifi_password, doc["wifi_password"], sizeof(config.wifi_password) - 1);
        }
        if (doc.containsKey("mqtt_server")) {
            strncpy(config.mqtt_server, doc["mqtt_server"], sizeof(config.mqtt_server) - 1);
        }
        if (doc.containsKey("mqtt_port")) {
            config.mqtt_port = doc["mqtt_port"];
        }
        if (doc.containsKey("mqtt_user")) {
            strncpy(config.mqtt_user, doc["mqtt_user"], sizeof(config.mqtt_user) - 1);
        }
        if (doc.containsKey("mqtt_password") && strlen(doc["mqtt_password"]) > 0) {
            strncpy(config.mqtt_password, doc["mqtt_password"], sizeof(config.mqtt_password) - 1);
        }
        if (doc.containsKey("topic_tank")) {
            strncpy(config.topic_tank_temp, doc["topic_tank"], sizeof(config.topic_tank_temp) - 1);
        }
        if (doc.containsKey("topic_out")) {
            strncpy(config.topic_out_pipe_temp, doc["topic_out"], sizeof(config.topic_out_pipe_temp) - 1);
        }
        if (doc.containsKey("topic_heat_in")) {
            strncpy(config.topic_heating_in_temp, doc["topic_heat_in"], sizeof(config.topic_heating_in_temp) - 1);
        }
        if (doc.containsKey("topic_heat_out")) {
            strncpy(config.topic_heating_out_temp, doc["topic_heat_out"], sizeof(config.topic_heating_out_temp) - 1);
        }
        if (doc.containsKey("min_tank")) {
            config.min_tank_temp = doc["min_tank"];
        }
        if (doc.containsKey("min_out")) {
            config.min_out_pipe_temp = doc["min_out"];
        }
        
        // Save to flash
        configManager.save();
        
        request->send(200, "text/plain", "Configuration saved");
        
        Serial.println("Configuration saved! Restarting...");
        delay(1000);
        ESP.restart();
    }
}
